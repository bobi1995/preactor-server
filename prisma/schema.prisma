datasource db {
  provider = "sqlserver"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// -------------------------------------------------------------
// | Resource & Scheduling Models                              |
// -------------------------------------------------------------

model Resource {
  id           Int      @id @default(autoincrement())
  name         String
  description  String?
  picture      String?
  color        String?
  externalCode String?  @unique @map("external_code")
  accumulative Boolean?

  scheduleId        Int?             @map("schedule_id")
  schedule          Schedule?        @relation(fields: [scheduleId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  changeoverGroupId Int?             @map("changeover_group_id")
  changeoverGroup   ChangeoverGroup? @relation(fields: [changeoverGroupId], references: [id])

  alternativeShifts  AlternativeShift[]
  orders             Order[]
  resourceGroupLinks ResourceToGroup[]

  @@map("Resources")
}

model ResourceGroup {
  id          Int    @id @default(autoincrement())
  name        String @unique
  description String // Corrected: @unique removed

  orders        Order[]
  resourceLinks ResourceToGroup[]

  @@map("Resource_groups")
}

model Shift {
  id        Int    @id @default(autoincrement())
  name      String @unique
  startHour String @map("start_time")
  endHour   String @map("end_time")

  schedulesMon      Schedule[]         @relation("MondayShift")
  schedulesTue      Schedule[]         @relation("TuesdayShift")
  schedulesWed      Schedule[]         @relation("WednesdayShift")
  schedulesThu      Schedule[]         @relation("ThursdayShift")
  schedulesFri      Schedule[]         @relation("FridayShift")
  schedulesSat      Schedule[]         @relation("SaturdayShift")
  schedulesSun      Schedule[]         @relation("SundayShift")
  alternativeShifts AlternativeShift[]
  breakLinks        BreakToShift[]

  @@map("Shifts")
}

model AlternativeShift {
  id        Int      @id @default(autoincrement())
  startDate DateTime @map("start_date")
  endDate   DateTime @map("end_date")

  shiftId    Int      @map("shift_id")
  shift      Shift    @relation(fields: [shiftId], references: [id])
  resourceId Int      @map("resource_id")
  resource   Resource @relation(fields: [resourceId], references: [id])

  @@map("Alternative_shifts")
}

model Schedule {
  id   Int    @id @default(autoincrement())
  name String @unique

  mondayId Int?   @map("monday")
  monday   Shift? @relation("MondayShift", fields: [mondayId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  tuesdayId Int?   @map("tuesday")
  tuesday   Shift? @relation("TuesdayShift", fields: [tuesdayId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  wednesdayId Int?   @map("wednesday")
  wednesday   Shift? @relation("WednesdayShift", fields: [wednesdayId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  thursdayId Int?   @map("thursday")
  thursday   Shift? @relation("ThursdayShift", fields: [thursdayId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  fridayId Int?   @map("friday")
  friday   Shift? @relation("FridayShift", fields: [fridayId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  saturdayId Int?   @map("saturday")
  saturday   Shift? @relation("SaturdayShift", fields: [saturdayId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  sundayId Int?   @map("sunday")
  sunday   Shift? @relation("SundayShift", fields: [sundayId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  resources Resource[]

  @@map("Schedules")
}

model Break {
  id        Int    @id @default(autoincrement())
  name      String @unique
  startTime String @map("start_time")
  endTime   String @map("end_time")

  shiftLinks BreakToShift[]

  @@map("Breaks")
}

model Order {
  id              Int      @id @default(autoincrement())
  orderNumber     String   @map("orno")
  operationNumber String   @map("opno")
  startTime       DateTime @map("start_time")
  endTime         DateTime @map("end_time")
  project         String?
  duration        Float?
  taskIndex       Float?   @map("task_index")
  partNumber      String?  @map("part_no")
  product         String?
  opName          String?  @map("op_name")
  remainingQuan   Float?   @map("remaining_quan")
  setupTime       Float?   @map("setup_time")

  resourceId      Int           @map("resource_id")
  resource        Resource      @relation(fields: [resourceId], references: [id])
  resourceGroupId Int           @map("resource_group_id")
  resourceGroup   ResourceGroup @relation(fields: [resourceGroupId], references: [id])

  @@map("Orders")
}

// -------------------------------------------------------------
// | Attributes & Changeover Models                            |
// -------------------------------------------------------------

model Attribute {
  id                  Int              @id @default(autoincrement())
  name                String           @unique
  isParam             Boolean          @default(true)
  attributeParameters AttrParam[]
  changeoverData      ChangeoverData[]
  changeoverTimes     ChangeoverTime[]
  orderAttributes     OrderAttribute[]

  @@map("Attributes")
}

model AttrParam {
  id             Int     @id @default(autoincrement())
  attributeValue String  @map("attribute_value")
  attributeNote  String? @map("attribute_note")

  attributeId Int       @map("attribute_id")
  attribute   Attribute @relation(fields: [attributeId], references: [id])

  changeoversFrom ChangeoverData[] @relation("From")
  changeoversTo   ChangeoverData[] @relation("To")
  orderAttributes OrderAttribute[]

  @@map("Attributes_parameters")
}

model ChangeoverGroup {
  id   Int    @id @default(autoincrement())
  name String @unique

  resources       Resource[]
  changeoverData  ChangeoverData[]
  changeoverTimes ChangeoverTime[]

  @@map("Changeover_groups")
}

model ChangeoverData {
  id        Int   @id @default(autoincrement())
  setupTime Float @map("setup_time")

  changeoverGroupId      Int             @map("changeover_group_id")
  changeoverGroup        ChangeoverGroup @relation(fields: [changeoverGroupId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  attributeId            Int             @map("attribute_id")
  attribute              Attribute       @relation(fields: [attributeId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  fromAttrParamId        Int             @map("from_attr_param_id")
  fromAttributeParameter AttrParam       @relation("From", fields: [fromAttrParamId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  toAttrParamId          Int             @map("to_attr_param_id")
  toAttributeParameter   AttrParam       @relation("To", fields: [toAttrParamId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@map("Changeover_data")
}

model ChangeoverTime {
  id             Int    @id @default(autoincrement())
  changeoverTime Float? @map("changeover_time")

  changeoverGroupId Int             @map("changeover_group_id")
  changeoverGroup   ChangeoverGroup @relation(fields: [changeoverGroupId], references: [id])
  attributeId       Int             @map("attribute_id")
  attribute         Attribute       @relation(fields: [attributeId], references: [id])

  @@map("Changeover_times")
}

model OrderRaw {
  // Mapping 'id' to 'OrdersId' as the unique primary key for specific operation steps
  id                Int       @id @default(autoincrement()) @map("OrdersId")
  belongsToOrderNo  Int       @map("BelongsToOrderNo")
  orderNo           String    @map("OrderNo")
  earliestStartDate DateTime? @map("EarliestStartDate")
  dueDate           DateTime? @map("DueDate")
  criticalRatio     Float?    @map("CriticalRatio")
  opNo              Int       @map("OpNo")
  operationName     String    @map("OperationName")
  resourceGroup     Int?      @map("ResourceGroup")
  opTimePerItem     Float?    @map("OpTimePerItem")
  batchTime         Float?    @map("BatchTime")
  quantityPerHour   Float?    @map("QuantityPerHour")
  effectiveOpTime   Float?    @map("EffectiveOpTime")
  demandDate        DateTime? @map("DemandDate")
  totalSetupTime    Float?    @map("TotalSetupTime")
  totalProcessTime  Float?    @map("TotalProcessTime")
  quantity          Float     @map("Quantity")
  partNo            String    @map("PartNo")
  product           String    @map("Product")

  // Relations
  attributes OrderAttribute[]

  @@map("Orders_Raw")
}

model OrderAttribute {
  id Int @id @default(autoincrement())

  orderId Int      @map("orderId")
  order   OrderRaw @relation(fields: [orderId], references: [id], onDelete: Cascade)

  attributeId Int       @map("attributeId")
  attribute   Attribute @relation(fields: [attributeId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  attributeParamId Int?       @map("attributeParamId")
  attributeParam   AttrParam? @relation(fields: [attributeParamId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  value            String?    @map("value") // Free text value

  @@map("Orders_attr")
}

// -------------------------------------------------------------
// | Explicit Many-to-Many Join Tables                         |
// -------------------------------------------------------------
// -------------------------------------------------------------
// | Explicit Many-to-Many Join Tables                         |
// -------------------------------------------------------------

model ResourceToGroup {
  resourceId      Int           @map("resource_id")
  resource        Resource      @relation(fields: [resourceId], references: [id])
  resourceGroupId Int           @map("resource_group_id")
  resourceGroup   ResourceGroup @relation(fields: [resourceGroupId], references: [id])
  createdAt       DateTime      @default(now()) @map("created_at")

  @@id([resourceId, resourceGroupId])
  @@map("REL_Resource_group")
}

model BreakToShift {
  breakId   Int      @map("break_id")
  break     Break    @relation(fields: [breakId], references: [id])
  shiftId   Int      @map("shift_id")
  shift     Shift    @relation(fields: [shiftId], references: [id])
  createdAt DateTime @default(now()) @map("created_at")

  @@id([breakId, shiftId])
  @@map("REL_Break_Shift")
}
